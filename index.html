# ============================================================
# IA AGENTE ULTRA++ — TODAS AS CAMADAS ATIVAS
# ============================================================

import sqlite3, datetime, uuid, random, time

# ============================================================
# BANCO DE DADOS
# ============================================================

db = sqlite3.connect("ia_ultra_plus.db")
c = db.cursor()

c.execute("""
CREATE TABLE IF NOT EXISTS leads (
    id TEXT PRIMARY KEY,
    score INTEGER,
    nivel TEXT,
    personalidade TEXT,
    ultima_interacao TEXT
)
""")

c.execute("""
CREATE TABLE IF NOT EXISTS logs (
    id TEXT,
    role TEXT,
    message TEXT,
    data TEXT
)
""")

c.execute("""
CREATE TABLE IF NOT EXISTS metrics (
    tipo TEXT,
    valor INTEGER
)
""")

db.commit()

# ============================================================
# PRODUTOS
# ============================================================

PRODUCTS = {
    "basico": {"nome": "Guia Do Zero ao Primeiro Pix", "preco": 5.99},
    "premium": {"nome": "Projeto Renda Digital + IA", "preco": 15.00}
}

# ============================================================
# ANALISADORES
# ============================================================

def intent(text):
    t = text.lower()
    if any(x in t for x in ["preço", "valor", "quanto"]): return "PRICE"
    if any(x in t for x in ["funciona", "vale", "confio"]): return "DOUBT"
    if any(x in t for x in ["comprar", "pix", "quero"]): return "BUY"
    if any(x in t for x in ["depois", "agora não"]): return "BLOCK"
    return "CHAT"

def personality(text):
    t = text.lower()
    if "medo" in t or "desconfiado" in t: return "cauteloso"
    if "rápido" in t or "direto" in t: return "direto"
    return "normal"

# ============================================================
# LEAD SCORING
# ============================================================

def lead_score(intent_type):
    if intent_type == "BUY": return 30
    if intent_type == "PRICE": return 20
    if intent_type == "DOUBT": return 10
    return 5

# ============================================================
# AGENTES
# ============================================================

class SalesAgent:
    def respond(self, intent_type, perfil):
        if intent_type == "PRICE":
            return "Tenho duas opções: 5,99 pra começar ou 15,00 com IA inclusa."
        if intent_type == "DOUBT":
            return "Funciona pra quem aplica. O foco é simplicidade."
        if intent_type == "BUY":
            return "Perfeito. Te mando o link agora?"
        if intent_type == "BLOCK":
            return "Entendo. Mas continuar parado costuma custar mais."
        return "Me conta, o que mais te trava hoje?"

class CopyAgent:
    def offer(self, product):
        return f"{product['nome']} por apenas R${product['preco']} — simples e direto."

class FollowUpAgent:
    def next_message(self):
        return random.choice([
            "Fiquei pensando no que você falou",
            "Conseguiu decidir?",
            "Quando fizer sentido, me chama"
        ])

# ============================================================
# IA PRINCIPAL
# ============================================================

class IAUltraPlus:
    def __init__(self):
        self.id = str(uuid.uuid4())
        self.sales = SalesAgent()
        self.copy = CopyAgent()
        self.follow = FollowUpAgent()
        self.score = 0

        c.execute("INSERT OR IGNORE INTO leads VALUES (?, ?, ?, ?, ?)",
                  (self.id, 0, "iniciante", "normal", now()))
        db.commit()

    def log(self, role, msg):
        c.execute("INSERT INTO logs VALUES (?, ?, ?, ?)",
                  (self.id, role, msg, now()))
        db.commit()

    def handle(self, msg):
        self.log("user", msg)

        i = intent(msg)
        p = personality(msg)
        self.score += lead_score(i)

        c.execute("""
        UPDATE leads SET score=?, personalidade=?, ultima_interacao=?
        WHERE id=?
        """, (self.score, p, now(), self.id))
        db.commit()

        resposta = self.sales.respond(i, p)
        self.log("agent", resposta)

        return resposta

# ============================================================
# UTIL
# ============================================================

def now():
    return datetime.datetime.now().strftime("%d/%m %H:%M")

# ============================================================
# EXECUÇÃO
# ============================================================

if __name__ == "__main__":
    ia = IAUltraPlus()
    print("IA: Fala, tudo certo?")

    while True:
        user = input("Cliente: ")
        if user.lower() in ["exit", "sair"]:
            break
        print("IA:", ia.handle(user))
